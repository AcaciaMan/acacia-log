import unittest
import subprocess
import os

class AcaciaLogTest(unittest.TestCase):

    def run_acacialog_script(self, args):
        script_path = os.path.join(os.path.dirname(__file__), '../../acacialog.py')
        result = subprocess.run(['python', script_path] + args, capture_output=True, text=True)
        return result.stdout.strip()

    def test_verbose_option(self):
        output = self.run_acacialog_script(['-verbose'])
        expected_output = "verbose mode on\nSuccess!"
        self.assertEqual(output, expected_output)

    def test_from_to_option(self):
        output = self.run_acacialog_script(['-from', '2015-02-08T11:53:02.310Z', '-to', '2015-02-09T12:53:03.311Z'])
        expected_output = """[wu] 2015-02-11 14:02:01.103 WindowsUpdate.log C:\\Windows

[wu] WindowsUpdate.log
2015-02-08      11:52:02:310     596    1514    DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    1514    IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    ffc     DnldMgr Caller SID for retrying failed download job: S-1-5-18
2015-02-08      11:52:02:310     596    1514    EP      Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 redir SecuredCli...
2015-02-08      11:52:02:310     596    1514    EP      Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 plugin S...
2015-02-09      12:53:03:311     597    1515    DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
2015-02-09      12:53:03:311     597    ffd     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B149}, up...
2015-02-09      12:53:03:311     597    1515    IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
2015-02-09      12:53:03:311     597    ffd     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B149}, up...
2015-02-09      12:53:03:311     597    ffd     DnldMgr Caller SID for retrying failed download job: S-1-5-19
2015-02-09      12:53:03:311     597    1515    EP      Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7783 redir SecuredCli...
2015-02-09      12:53:03:311     597    1515    EP      Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7783 plugin S..."""
        self.assertEqual(output, expected_output)

    def test_include_exclude_option(self):
        output = self.run_acacialog_script(['-include', 'wu', '-exclude', 'cbs'])
        expected_output = """[wu] 2015-02-11 14:02:01.103 WindowsUpdate.log C:\\Windows

[wu] WindowsUpdate.log
2015-02-08      11:52:02:310     596    1514    DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    1514    IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    ffc     DnldMgr Caller SID for retrying failed download job: S-1-5-18
2015-02-08      11:52:02:310     596    1514    EP      Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 redir SecuredCli...
2015-02-08      11:52:02:310     596    1514    EP      Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 plugin S..."""
        self.assertEqual(output, expected_output)

    def test_top_option(self):
        output = self.run_acacialog_script(['-top', '5'])
        expected_output = """0:00:00.000000 2015-02-08 11:52:02.310 596 1514 DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
0:00:00.000000 2015-02-08 11:52:02.310 596 1514 IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr Caller SID for retrying failed download job: S-1-5-18"""
        self.assertEqual(output, expected_output)

    def test_l_option(self):
        output = self.run_acacialog_script(['-l'])
        expected_output = """wu 2015-02-11 14:02:01.103 WindowsUpdate.log C:\\Windows"""
        self.assertEqual(output, expected_output)

    def test_i_option(self):
        output = self.run_acacialog_script(['-i'])
        expected_output = """[wu] 2015-02-11 14:02:01.103 WindowsUpdate.log C:\\Windows

[wu] WindowsUpdate.log
2015-02-08      11:52:02:310     596    1514    DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    1514    IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
2015-02-08      11:52:02:310     596    ffc     DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
2015-02-08      11:52:02:310     596    ffc     DnldMgr Caller SID for retrying failed download job: S-1-5-18
2015-02-08      11:52:02:310     596    1514    EP      Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 redir SecuredCli...
2015-02-08      11:52:02:310     596    1514    EP      Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 plugin S..."""
        self.assertEqual(output, expected_output)

    def test_o_option(self):
        output = self.run_acacialog_script(['-o'])
        expected_output = """0:00:00.000000 2015-02-08 11:52:02.310 596 1514 DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
0:00:00.000000 2015-02-08 11:52:02.310 596 1514 IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
0:00:00.000000 2015-02-08 11:52:02.310 596 ffc DnldMgr Caller SID for retrying failed download job: S-1-5-18"""
        self.assertEqual(output, expected_output)

    def test_r_option(self):
        output = self.run_acacialog_script(['-r'])
        expected_output = """[wu] WindowsUpdate.log
 DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
 DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
 IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
 DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B148}, up...
 DnldMgr Caller SID for retrying failed download job: S-1-5-18
 EP Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 redir SecuredCli...
 EP Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7782 plugin S...
 DnldMgr Fetching dynamic data from service 117CAB2D-82B1-4B5A-A08...
 DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B149}, up...
 IdleTmr WU operation (CDynamicDownloadDataFetcher::FetchAndStoreD...
 DnldMgr 403'd BITS job {6171D9FD-EFD1-4A70-B17B-F4CEF266B149}, up...
 DnldMgr Caller SID for retrying failed download job: S-1-5-19
 EP Got 117CAB2D-82B1-4B5A-A08C-4D62DBEE7783 redir SecuredCli...
 EP Got service 117CAB2D-82B1-4B5A-A08C-4D62DBEE7783 plugin S..."""
        self.assertEqual(output, expected_output)

if __name__ == '__main__':
    unittest.main()
